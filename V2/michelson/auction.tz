{ parameter
    (or (bool %setPause)
        (or (address %updateNftAddress)
            (or (address %updateRoyaltiesAddress)
                (or (nat %updateFee)
                    (or (address %updateOracleAddress)
                        (or (pair %updateAllowedTokens
                               (string %token_symbol)
                               (or %direction (address %add_token) (unit %remove_token)))
                            (or (pair %startAuction
                                   (nat %token_id)
                                   (timestamp %start_time)
                                   (nat %period)
                                   (nat %starting_price)
                                   (nat %reveal_time)
                                   (bytes %reserved_price_hashed)
                                   (nat %adding_period)
                                   (nat %extra_duration)
                                   (nat %token_amount)
                                   (address %token_origin)
                                   (string %token_symbol)
                                   (set %accepted_tokens string))
                                (or (pair %bid (nat %swap_id) (string %token_symbol) (nat %ft_amount))
                                    (or (pair %revealPrice
                                           (nat %swap_id)
                                           (pair %revealed_price (nat %price) (string %token_symbol) (string %secret))
                                           (bool %permit_lower))
                                        (or (nat %removeFromMarketplace) (nat %collect))))))))))) ;
  storage
    (pair (address %nft_address)
          (address %royalties_address)
          (big_map %swaps
             nat
             (pair (address %owner)
                   (nat %token_id)
                   (pair %auction
                      (nat %current_price)
                      (address %current_highest_bidder)
                      (string %current_symbol)
                      (timestamp %start_time)
                      (timestamp %end_time)
                      (bytes %reserved_price_hashed)
                      (nat %reserved_price)
                      (bool %permit_lower)
                      (timestamp %reveal_time)
                      (nat %adding_period)
                      (nat %extra_duration)
                      (nat %reveal_counter))
                   (nat %token_amount)
                   (address %origin)
                   (string %token_symbol)
                   (set %accepted_tokens string)))
          (nat %next_swap_id)
          (nat %management_fee_rate)
          (bool %paused)
          (big_map %allowed_tokens
             string
             (pair (string %token_symbol) (address %fa12_address)))
          (big_map %available_pairs (pair string string) string)
          (address %oracle)
          (address %multisig)
          (address %treasury)) ;
  code { LAMBDA
           (pair string
                 nat
                 string
                 address
                 address
                 (big_map
                    nat
                    (pair address
                          nat
                          (pair nat
                                address
                                string
                                timestamp
                                timestamp
                                bytes
                                nat
                                bool
                                timestamp
                                nat
                                nat
                                nat)
                          nat
                          address
                          string
                          (set string)))
                 nat
                 nat
                 bool
                 (big_map string (pair string address))
                 (big_map (pair string string) string)
                 address
                 address
                 address)
           nat
           { UNPAIR 4 ;
             DUP 3 ;
             DUP 2 ;
             COMPARE ;
             EQ ;
             IF { DIG 2 ; DIG 3 ; DROP 3 }
                { PUSH string "USD" ;
                  DUP 4 ;
                  COMPARE ;
                  EQ ;
                  IF { DUP 4 ;
                       GET 15 ;
                       DIG 3 ;
                       DIG 2 ;
                       PAIR ;
                       GET ;
                       IF_NONE
                         { PUSH nat 229 ; FAILWITH }
                         { PUSH string "" ; PUSH bool True ; DIG 2 ; PAIR ; PAIR } }
                     { PUSH string "USD" ;
                       DUP 2 ;
                       COMPARE ;
                       EQ ;
                       IF { DUP 4 ;
                            GET 15 ;
                            SWAP ;
                            DIG 3 ;
                            PAIR ;
                            GET ;
                            IF_NONE
                              { PUSH nat 229 ; FAILWITH }
                              { PUSH string "" ; PUSH bool False ; DIG 2 ; PAIR ; PAIR } }
                          { DUP 4 ;
                            GET 15 ;
                            PUSH string "USD" ;
                            DIG 2 ;
                            PAIR ;
                            GET ;
                            IF_NONE { PUSH nat 229 ; FAILWITH } {} ;
                            DUP 4 ;
                            GET 15 ;
                            PUSH string "USD" ;
                            DIG 4 ;
                            PAIR ;
                            GET ;
                            IF_NONE { PUSH nat 229 ; FAILWITH } {} ;
                            PUSH bool True ;
                            DIG 2 ;
                            PAIR ;
                            PAIR } } ;
                  UNPAIR ;
                  UNPAIR ;
                  PUSH nat 1000000 ;
                  PUSH string "" ;
                  DUP 5 ;
                  COMPARE ;
                  EQ ;
                  IF { DIG 3 ;
                       DROP ;
                       DIG 4 ;
                       GET 17 ;
                       DIG 2 ;
                       VIEW "getPrice" (pair timestamp nat) ;
                       IF_NONE { PUSH nat 230 ; FAILWITH } {} ;
                       CDR ;
                       DIG 2 ;
                       IF { DIG 2 ;
                            MUL ;
                            EDIV ;
                            IF_NONE { PUSH string "DIV by 0" ; FAILWITH } {} ;
                            CAR }
                          { SWAP ;
                            DIG 2 ;
                            MUL ;
                            EDIV ;
                            IF_NONE { PUSH string "DIV by 0" ; FAILWITH } {} ;
                            CAR } }
                     { DIG 2 ;
                       DROP 2 ;
                       DUP 4 ;
                       GET 17 ;
                       SWAP ;
                       VIEW "getPrice" (pair timestamp nat) ;
                       IF_NONE { PUSH nat 230 ; FAILWITH } {} ;
                       CDR ;
                       DIG 3 ;
                       GET 17 ;
                       DIG 2 ;
                       VIEW "getPrice" (pair timestamp nat) ;
                       IF_NONE { PUSH nat 230 ; FAILWITH } {} ;
                       CDR ;
                       SWAP ;
                       DIG 2 ;
                       MUL ;
                       EDIV ;
                       IF_NONE { PUSH string "DIV by 0" ; FAILWITH } {} ;
                       CAR } } } ;
         LAMBDA
           (pair string
                 address
                 address
                 (big_map
                    nat
                    (pair address
                          nat
                          (pair nat
                                address
                                string
                                timestamp
                                timestamp
                                bytes
                                nat
                                bool
                                timestamp
                                nat
                                nat
                                nat)
                          nat
                          address
                          string
                          (set string)))
                 nat
                 nat
                 bool
                 (big_map string (pair string address))
                 (big_map (pair string string) string)
                 address
                 address
                 address)
           address
           { UNPAIR ;
             SWAP ;
             GET 13 ;
             SWAP ;
             GET ;
             IF_NONE { PUSH nat 231 ; FAILWITH } { CDR } } ;
         DIG 2 ;
         UNPAIR ;
         IF_LEFT
           { DIG 2 ;
             DIG 3 ;
             DROP 2 ;
             SELF_ADDRESS ;
             DUP 3 ;
             GET 19 ;
             SENDER ;
             COMPARE ;
             NEQ ;
             IF { DUP 3 ;
                  DIG 3 ;
                  GET 19 ;
                  CONTRACT %callMultisig
                    (pair (pair %entrypoint_signature
                             (pair (string %name) (bytes %params))
                             (address %source_contract))
                          (lambda %callback unit (list operation))) ;
                  IF_NONE
                    { SWAP ; DIG 2 ; DROP 2 ; PUSH string "no call entrypoint" ; FAILWITH }
                    { DUP 4 ;
                      PACK ;
                      SHA256 ;
                      SELF_ADDRESS ;
                      SWAP ;
                      PUSH string "setPause" ;
                      PAIR ;
                      PAIR ;
                      SWAP ;
                      PUSH mutez 0 ;
                      LAMBDA
                        (pair (pair address bool) unit)
                        (list operation)
                        { UNPAIR ;
                          UNPAIR ;
                          DIG 2 ;
                          DROP ;
                          CONTRACT %setPause bool ;
                          IF_NONE
                            { DROP ; PUSH string "no setPause entrypoint" ; FAILWITH }
                            { NIL operation ; SWAP ; PUSH mutez 0 ; DIG 3 ; TRANSFER_TOKENS ; CONS } } ;
                      DUP 7 ;
                      DUP 7 ;
                      PAIR ;
                      APPLY ;
                      DIG 5 ;
                      DIG 6 ;
                      DROP 2 ;
                      DIG 3 ;
                      PAIR ;
                      TRANSFER_TOKENS ;
                      NIL operation ;
                      SWAP ;
                      CONS } }
                { DROP ; UPDATE 11 ; NIL operation } ;
             PAIR }
           { IF_LEFT
               { DIG 2 ;
                 DIG 3 ;
                 DROP 2 ;
                 DUP 2 ;
                 GET 19 ;
                 SENDER ;
                 COMPARE ;
                 NEQ ;
                 IF { SELF_ADDRESS ;
                      DUP 3 ;
                      DIG 3 ;
                      GET 19 ;
                      CONTRACT %callMultisig
                        (pair (pair %entrypoint_signature
                                 (pair (string %name) (bytes %params))
                                 (address %source_contract))
                              (lambda %callback unit (list operation))) ;
                      IF_NONE
                        { SWAP ; DIG 2 ; DROP 2 ; PUSH string "no call entrypoint" ; FAILWITH }
                        { DUP 4 ;
                          PACK ;
                          SHA256 ;
                          SELF_ADDRESS ;
                          SWAP ;
                          PUSH string "updateNftAddress" ;
                          PAIR ;
                          PAIR ;
                          SWAP ;
                          PUSH mutez 0 ;
                          LAMBDA
                            (pair (pair address address) unit)
                            (list operation)
                            { UNPAIR ;
                              UNPAIR ;
                              DIG 2 ;
                              DROP ;
                              CONTRACT %updateNftAddress address ;
                              IF_NONE
                                { DROP ; PUSH string "no updateNftAddress entrypoint" ; FAILWITH }
                                { NIL operation ; SWAP ; PUSH mutez 0 ; DIG 3 ; TRANSFER_TOKENS ; CONS } } ;
                          DUP 7 ;
                          DUP 7 ;
                          PAIR ;
                          APPLY ;
                          DIG 5 ;
                          DIG 6 ;
                          DROP 2 ;
                          DIG 3 ;
                          PAIR ;
                          TRANSFER_TOKENS ;
                          NIL operation ;
                          SWAP ;
                          CONS } }
                    { UPDATE 1 ; NIL operation } ;
                 PAIR }
               { IF_LEFT
                   { DIG 2 ;
                     DIG 3 ;
                     DROP 2 ;
                     DUP 2 ;
                     GET 19 ;
                     SENDER ;
                     COMPARE ;
                     NEQ ;
                     IF { SELF_ADDRESS ;
                          DUP 3 ;
                          DIG 3 ;
                          GET 19 ;
                          CONTRACT %callMultisig
                            (pair (pair %entrypoint_signature
                                     (pair (string %name) (bytes %params))
                                     (address %source_contract))
                                  (lambda %callback unit (list operation))) ;
                          IF_NONE
                            { SWAP ; DIG 2 ; DROP 2 ; PUSH string "no call entrypoint" ; FAILWITH }
                            { DUP 4 ;
                              PACK ;
                              SHA256 ;
                              SELF_ADDRESS ;
                              SWAP ;
                              PUSH string "updateNftAddress" ;
                              PAIR ;
                              PAIR ;
                              SWAP ;
                              PUSH mutez 0 ;
                              LAMBDA
                                (pair (pair address address) unit)
                                (list operation)
                                { UNPAIR ;
                                  UNPAIR ;
                                  DIG 2 ;
                                  DROP ;
                                  CONTRACT %updateRoyaltiesAddress address ;
                                  IF_NONE
                                    { DROP ; PUSH string "no updateRoyaltiesAddress entrypoint" ; FAILWITH }
                                    { NIL operation ; SWAP ; PUSH mutez 0 ; DIG 3 ; TRANSFER_TOKENS ; CONS } } ;
                              DUP 7 ;
                              DUP 7 ;
                              PAIR ;
                              APPLY ;
                              DIG 5 ;
                              DIG 6 ;
                              DROP 2 ;
                              DIG 3 ;
                              PAIR ;
                              TRANSFER_TOKENS ;
                              NIL operation ;
                              SWAP ;
                              CONS } }
                        { UPDATE 3 ; NIL operation } ;
                     PAIR }
                   { IF_LEFT
                       { DIG 2 ;
                         DIG 3 ;
                         DROP 2 ;
                         DUP 2 ;
                         GET 19 ;
                         SENDER ;
                         COMPARE ;
                         NEQ ;
                         IF { SELF_ADDRESS ;
                              DUP 3 ;
                              DIG 3 ;
                              GET 19 ;
                              CONTRACT %callMultisig
                                (pair (pair %entrypoint_signature
                                         (pair (string %name) (bytes %params))
                                         (address %source_contract))
                                      (lambda %callback unit (list operation))) ;
                              IF_NONE
                                { SWAP ; DIG 2 ; DROP 2 ; PUSH string "no call entrypoint" ; FAILWITH }
                                { DUP 4 ;
                                  PACK ;
                                  SHA256 ;
                                  SELF_ADDRESS ;
                                  SWAP ;
                                  PUSH string "updateFee" ;
                                  PAIR ;
                                  PAIR ;
                                  SWAP ;
                                  PUSH mutez 0 ;
                                  LAMBDA
                                    (pair (pair address nat) unit)
                                    (list operation)
                                    { UNPAIR ;
                                      UNPAIR ;
                                      DIG 2 ;
                                      DROP ;
                                      CONTRACT %updateFee nat ;
                                      IF_NONE
                                        { DROP ; PUSH string "no updateFee entrypoint" ; FAILWITH }
                                        { NIL operation ; SWAP ; PUSH mutez 0 ; DIG 3 ; TRANSFER_TOKENS ; CONS } } ;
                                  DUP 7 ;
                                  DUP 7 ;
                                  PAIR ;
                                  APPLY ;
                                  DIG 5 ;
                                  DIG 6 ;
                                  DROP 2 ;
                                  DIG 3 ;
                                  PAIR ;
                                  TRANSFER_TOKENS ;
                                  NIL operation ;
                                  SWAP ;
                                  CONS } }
                            { UPDATE 9 ; NIL operation } ;
                         PAIR }
                       { IF_LEFT
                           { DIG 2 ;
                             DIG 3 ;
                             DROP 2 ;
                             DUP 2 ;
                             GET 19 ;
                             SENDER ;
                             COMPARE ;
                             NEQ ;
                             IF { SELF_ADDRESS ;
                                  DUP 3 ;
                                  DIG 3 ;
                                  GET 19 ;
                                  CONTRACT %callMultisig
                                    (pair (pair %entrypoint_signature
                                             (pair (string %name) (bytes %params))
                                             (address %source_contract))
                                          (lambda %callback unit (list operation))) ;
                                  IF_NONE
                                    { SWAP ; DIG 2 ; DROP 2 ; PUSH string "no call entrypoint" ; FAILWITH }
                                    { DUP 4 ;
                                      PACK ;
                                      SHA256 ;
                                      SELF_ADDRESS ;
                                      SWAP ;
                                      PUSH string "updateOracleAddress" ;
                                      PAIR ;
                                      PAIR ;
                                      SWAP ;
                                      PUSH mutez 0 ;
                                      LAMBDA
                                        (pair (pair address address) unit)
                                        (list operation)
                                        { UNPAIR ;
                                          UNPAIR ;
                                          DIG 2 ;
                                          DROP ;
                                          CONTRACT %updateOracleAddress address ;
                                          IF_NONE
                                            { DROP ; PUSH string "no updateOracleAddress entrypoint" ; FAILWITH }
                                            { NIL operation ; SWAP ; PUSH mutez 0 ; DIG 3 ; TRANSFER_TOKENS ; CONS } } ;
                                      DUP 7 ;
                                      DUP 7 ;
                                      PAIR ;
                                      APPLY ;
                                      DIG 5 ;
                                      DIG 6 ;
                                      DROP 2 ;
                                      DIG 3 ;
                                      PAIR ;
                                      TRANSFER_TOKENS ;
                                      NIL operation ;
                                      SWAP ;
                                      CONS } }
                                { UPDATE 17 ; NIL operation } ;
                             PAIR }
                           { IF_LEFT
                               { DIG 2 ;
                                 DIG 3 ;
                                 DROP 2 ;
                                 DUP 2 ;
                                 GET 19 ;
                                 SENDER ;
                                 COMPARE ;
                                 NEQ ;
                                 IF { SELF_ADDRESS ;
                                      DUP 3 ;
                                      DIG 3 ;
                                      GET 19 ;
                                      CONTRACT %callMultisig
                                        (pair (pair %entrypoint_signature
                                                 (pair (string %name) (bytes %params))
                                                 (address %source_contract))
                                              (lambda %callback unit (list operation))) ;
                                      IF_NONE
                                        { SWAP ; DIG 2 ; DROP 2 ; PUSH string "no call entrypoint" ; FAILWITH }
                                        { DUP 4 ;
                                          PACK ;
                                          SHA256 ;
                                          SELF_ADDRESS ;
                                          SWAP ;
                                          PUSH string "updateAllowedTokens" ;
                                          PAIR ;
                                          PAIR ;
                                          SWAP ;
                                          PUSH mutez 0 ;
                                          LAMBDA
                                            (pair (pair address (pair string (or address unit))) unit)
                                            (list operation)
                                            { UNPAIR ;
                                              UNPAIR ;
                                              DIG 2 ;
                                              DROP ;
                                              CONTRACT %updateAllowedTokens
                                                (pair (string %token_symbol)
                                                      (or %direction (address %add_token) (unit %remove_token))) ;
                                              IF_NONE
                                                { DROP ; PUSH string "no updateAllowedTokens entrypoint" ; FAILWITH }
                                                { NIL operation ; SWAP ; PUSH mutez 0 ; DIG 3 ; TRANSFER_TOKENS ; CONS } } ;
                                          DUP 7 ;
                                          DUP 7 ;
                                          PAIR ;
                                          APPLY ;
                                          DIG 5 ;
                                          DIG 6 ;
                                          DROP 2 ;
                                          DIG 3 ;
                                          PAIR ;
                                          TRANSFER_TOKENS ;
                                          NIL operation ;
                                          SWAP ;
                                          CONS } ;
                                      PAIR }
                                    { DUP ;
                                      CDR ;
                                      IF_LEFT
                                        { DUP 3 ;
                                          GET 13 ;
                                          DUP 3 ;
                                          CAR ;
                                          MEM ;
                                          IF { DROP 3 ; PUSH nat 234 ; FAILWITH }
                                             { DUP 3 ;
                                               GET 15 ;
                                               PUSH string "USD" ;
                                               DUP 4 ;
                                               CAR ;
                                               PAIR ;
                                               MEM ;
                                               IF { DROP 3 ; PUSH nat 235 ; FAILWITH }
                                                  { DUP 3 ;
                                                    DUP 4 ;
                                                    GET 13 ;
                                                    DIG 2 ;
                                                    DUP 4 ;
                                                    CAR ;
                                                    PAIR ;
                                                    SOME ;
                                                    DUP 4 ;
                                                    CAR ;
                                                    UPDATE ;
                                                    UPDATE 13 ;
                                                    DIG 2 ;
                                                    GET 15 ;
                                                    PUSH string "-USD" ;
                                                    DUP 4 ;
                                                    CAR ;
                                                    CONCAT ;
                                                    SOME ;
                                                    PUSH string "USD" ;
                                                    DIG 4 ;
                                                    CAR ;
                                                    PAIR ;
                                                    UPDATE ;
                                                    UPDATE 15 ;
                                                    NIL operation ;
                                                    PAIR } } }
                                        { DROP ;
                                          DUP 2 ;
                                          DUP 3 ;
                                          GET 13 ;
                                          NONE (pair string address) ;
                                          DUP 4 ;
                                          CAR ;
                                          UPDATE ;
                                          UPDATE 13 ;
                                          DIG 2 ;
                                          GET 15 ;
                                          NONE string ;
                                          PUSH string "USD" ;
                                          DIG 4 ;
                                          CAR ;
                                          PAIR ;
                                          UPDATE ;
                                          UPDATE 15 ;
                                          NIL operation ;
                                          PAIR } } }
                               { IF_LEFT
                                   { DIG 2 ;
                                     DIG 3 ;
                                     DROP 2 ;
                                     DUP 2 ;
                                     GET 11 ;
                                     IF { DROP 2 ; PUSH nat 220 ; FAILWITH }
                                        { SOURCE ;
                                          SENDER ;
                                          COMPARE ;
                                          NEQ ;
                                          IF { DROP 2 ; PUSH nat 236 ; FAILWITH }
                                             { NOW ;
                                               DUP 2 ;
                                               GET 3 ;
                                               COMPARE ;
                                               LT ;
                                               IF { DROP 2 ; PUSH nat 207 ; FAILWITH }
                                                  { PUSH nat 0 ;
                                                    DUP 2 ;
                                                    GET 5 ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF { DROP 2 ; PUSH nat 208 ; FAILWITH }
                                                       { PUSH nat 0 ;
                                                         DUP 2 ;
                                                         GET 13 ;
                                                         COMPARE ;
                                                         NEQ ;
                                                         PUSH nat 30 ;
                                                         DUP 3 ;
                                                         GET 13 ;
                                                         COMPARE ;
                                                         LT ;
                                                         PUSH nat 300 ;
                                                         DUP 4 ;
                                                         GET 13 ;
                                                         COMPARE ;
                                                         GT ;
                                                         OR ;
                                                         AND ;
                                                         IF { DROP 2 ; PUSH nat 214 ; FAILWITH }
                                                            { DUP 2 ;
                                                              GET 13 ;
                                                              DUP 2 ;
                                                              GET 21 ;
                                                              MEM ;
                                                              NOT ;
                                                              IF { DROP 2 ; PUSH nat 231 ; FAILWITH }
                                                                 { NIL (pair address (list (pair address nat nat))) ;
                                                                   NIL (pair address nat nat) ;
                                                                   DUP 3 ;
                                                                   GET 17 ;
                                                                   DUP 4 ;
                                                                   CAR ;
                                                                   SELF_ADDRESS ;
                                                                   PAIR 3 ;
                                                                   CONS ;
                                                                   SENDER ;
                                                                   PAIR ;
                                                                   CONS ;
                                                                   DUP 2 ;
                                                                   GET 19 ;
                                                                   CONTRACT %transfer (list (pair address (list (pair address nat nat)))) ;
                                                                   IF_NONE { PUSH nat 201 ; FAILWITH } {} ;
                                                                   SWAP ;
                                                                   MAP { DUP ;
                                                                         CDR ;
                                                                         MAP { DUP ; GET 4 ; DUP 2 ; GET 3 ; PAIR ; SWAP ; CAR ; PAIR } ;
                                                                         SWAP ;
                                                                         CAR ;
                                                                         PAIR } ;
                                                                   SWAP ;
                                                                   PUSH mutez 0 ;
                                                                   DIG 2 ;
                                                                   TRANSFER_TOKENS ;
                                                                   PUSH nat 0 ;
                                                                   DUP 3 ;
                                                                   GET 15 ;
                                                                   DUP 4 ;
                                                                   GET 13 ;
                                                                   DUP 5 ;
                                                                   GET 9 ;
                                                                   INT ;
                                                                   DUP 6 ;
                                                                   GET 5 ;
                                                                   INT ;
                                                                   DUP 7 ;
                                                                   GET 3 ;
                                                                   ADD ;
                                                                   ADD ;
                                                                   PUSH bool False ;
                                                                   PUSH nat 0 ;
                                                                   DUP 8 ;
                                                                   GET 11 ;
                                                                   DUP 9 ;
                                                                   GET 5 ;
                                                                   INT ;
                                                                   DUP 10 ;
                                                                   GET 3 ;
                                                                   ADD ;
                                                                   DUP 10 ;
                                                                   GET 3 ;
                                                                   DUP 11 ;
                                                                   GET 21 ;
                                                                   SELF_ADDRESS ;
                                                                   DUP 13 ;
                                                                   GET 7 ;
                                                                   PAIR 12 ;
                                                                   PUSH nat 0 ;
                                                                   DUP 4 ;
                                                                   GET 17 ;
                                                                   COMPARE ;
                                                                   EQ ;
                                                                   IF { DROP 3 ; PUSH nat 227 ; FAILWITH }
                                                                      { DUP 4 ;
                                                                        GET 5 ;
                                                                        DUP 4 ;
                                                                        GET 22 ;
                                                                        DUP 5 ;
                                                                        GET 21 ;
                                                                        DUP 6 ;
                                                                        GET 19 ;
                                                                        DUP 7 ;
                                                                        GET 17 ;
                                                                        DIG 5 ;
                                                                        DIG 7 ;
                                                                        CAR ;
                                                                        SENDER ;
                                                                        PAIR 7 ;
                                                                        SOME ;
                                                                        DUP 4 ;
                                                                        GET 7 ;
                                                                        PAIR 3 ;
                                                                        UNPAIR 3 ;
                                                                        UPDATE ;
                                                                        NIL operation ;
                                                                        DIG 2 ;
                                                                        CONS ;
                                                                        PAIR } ;
                                                                   UNPAIR ;
                                                                   PUSH nat 1 ;
                                                                   DUP 4 ;
                                                                   GET 7 ;
                                                                   ADD ;
                                                                   DIG 3 ;
                                                                   SWAP ;
                                                                   UPDATE 7 ;
                                                                   DIG 2 ;
                                                                   UPDATE 5 ;
                                                                   SWAP ;
                                                                   PAIR } } } } } } }
                                   { IF_LEFT
                                       { DUP 2 ;
                                         GET 11 ;
                                         IF { DROP 4 ; PUSH nat 220 ; FAILWITH }
                                            { DUP 2 ;
                                              GET 5 ;
                                              DUP 2 ;
                                              CAR ;
                                              GET ;
                                              IF_NONE { PUSH nat 202 ; FAILWITH } {} ;
                                              DUP ;
                                              CAR ;
                                              SENDER ;
                                              COMPARE ;
                                              EQ ;
                                              IF { DROP 5 ; PUSH nat 223 ; FAILWITH }
                                                 { DUP ;
                                                   GET 5 ;
                                                   DUP 2 ;
                                                   GET 12 ;
                                                   DUP 4 ;
                                                   GET 3 ;
                                                   MEM ;
                                                   NOT ;
                                                   IF { PUSH nat 233 ; FAILWITH }
                                                      { PUSH string "XTZ" ;
                                                        DUP 4 ;
                                                        GET 3 ;
                                                        COMPARE ;
                                                        EQ ;
                                                        IF { DUP 3 ;
                                                             GET 4 ;
                                                             AMOUNT ;
                                                             PUSH mutez 1 ;
                                                             SWAP ;
                                                             EDIV ;
                                                             IF_NONE { PUSH string "DIV by 0" ; FAILWITH } {} ;
                                                             CAR ;
                                                             COMPARE ;
                                                             NEQ ;
                                                             IF { PUSH nat 232 ; FAILWITH }
                                                                { AMOUNT ;
                                                                  PUSH mutez 1 ;
                                                                  SWAP ;
                                                                  EDIV ;
                                                                  IF_NONE { PUSH string "DIV by 0" ; FAILWITH } {} ;
                                                                  CAR } }
                                                           { DUP 3 ; GET 4 } } ;
                                                   DUP 5 ;
                                                   DUP 5 ;
                                                   GET 3 ;
                                                   DUP 4 ;
                                                   CAR ;
                                                   DUP 6 ;
                                                   GET 11 ;
                                                   PAIR 4 ;
                                                   DIG 7 ;
                                                   SWAP ;
                                                   EXEC ;
                                                   DUP 2 ;
                                                   COMPARE ;
                                                   LE ;
                                                   IF { DROP 6 ; PUSH nat 209 ; FAILWITH }
                                                      { DUP 2 ;
                                                        GET 7 ;
                                                        NOW ;
                                                        COMPARE ;
                                                        LT ;
                                                        IF { DROP 6 ; PUSH nat 225 ; FAILWITH }
                                                           { DUP 2 ;
                                                             GET 9 ;
                                                             NOW ;
                                                             COMPARE ;
                                                             GT ;
                                                             IF { DROP 6 ; PUSH nat 226 ; FAILWITH }
                                                                { DUP 2 ;
                                                                  GET 19 ;
                                                                  INT ;
                                                                  DUP 3 ;
                                                                  GET 9 ;
                                                                  SUB ;
                                                                  NOW ;
                                                                  COMPARE ;
                                                                  GT ;
                                                                  IF { DUP 2 ; GET 21 ; INT ; DUP 3 ; GET 9 ; ADD } { DUP 2 ; GET 9 } ;
                                                                  DUP 3 ;
                                                                  DUP 3 ;
                                                                  UPDATE 1 ;
                                                                  SENDER ;
                                                                  UPDATE 3 ;
                                                                  DUP 6 ;
                                                                  GET 3 ;
                                                                  UPDATE 5 ;
                                                                  SWAP ;
                                                                  UPDATE 9 ;
                                                                  PUSH string "XTZ" ;
                                                                  DUP 6 ;
                                                                  GET 3 ;
                                                                  COMPARE ;
                                                                  NEQ ;
                                                                  IF { DUP 6 ;
                                                                       DUP 6 ;
                                                                       GET 3 ;
                                                                       PAIR ;
                                                                       DUP 8 ;
                                                                       SWAP ;
                                                                       EXEC ;
                                                                       NIL operation ;
                                                                       DIG 3 ;
                                                                       SELF_ADDRESS ;
                                                                       SENDER ;
                                                                       DIG 4 ;
                                                                       PAIR 4 ;
                                                                       UNPAIR 4 ;
                                                                       CONTRACT %transfer (pair (address %from) (address %to) (nat %value)) ;
                                                                       IF_NONE { PUSH nat 228 ; FAILWITH } {} ;
                                                                       PUSH mutez 0 ;
                                                                       DIG 4 ;
                                                                       DIG 4 ;
                                                                       DIG 4 ;
                                                                       PAIR 3 ;
                                                                       TRANSFER_TOKENS ;
                                                                       CONS }
                                                                     { SWAP ; DROP ; NIL operation } ;
                                                                  SELF_ADDRESS ;
                                                                  DUP 4 ;
                                                                  GET 3 ;
                                                                  COMPARE ;
                                                                  EQ ;
                                                                  IF { DIG 2 ; DIG 6 ; DROP 2 }
                                                                     { PUSH string "XTZ" ;
                                                                       DUP 4 ;
                                                                       GET 5 ;
                                                                       COMPARE ;
                                                                       EQ ;
                                                                       IF { DIG 6 ;
                                                                            DROP ;
                                                                            PUSH mutez 1 ;
                                                                            DUP 4 ;
                                                                            CAR ;
                                                                            MUL ;
                                                                            DIG 3 ;
                                                                            GET 3 ;
                                                                            CONTRACT unit ;
                                                                            IF_NONE { PUSH nat 205 ; FAILWITH } {} ;
                                                                            SWAP ;
                                                                            UNIT ;
                                                                            TRANSFER_TOKENS }
                                                                          { DUP 6 ;
                                                                            DUP 4 ;
                                                                            GET 5 ;
                                                                            PAIR ;
                                                                            DIG 7 ;
                                                                            SWAP ;
                                                                            EXEC ;
                                                                            SWAP ;
                                                                            DUP 4 ;
                                                                            CAR ;
                                                                            DIG 4 ;
                                                                            GET 3 ;
                                                                            SELF_ADDRESS ;
                                                                            DIG 4 ;
                                                                            PAIR 4 ;
                                                                            UNPAIR 4 ;
                                                                            CONTRACT %transfer (pair (address %from) (address %to) (nat %value)) ;
                                                                            IF_NONE { PUSH nat 228 ; FAILWITH } {} ;
                                                                            PUSH mutez 0 ;
                                                                            DIG 4 ;
                                                                            DIG 4 ;
                                                                            DIG 4 ;
                                                                            PAIR 3 ;
                                                                            TRANSFER_TOKENS } ;
                                                                       CONS } ;
                                                                  DUP 5 ;
                                                                  DIG 5 ;
                                                                  GET 5 ;
                                                                  DIG 4 ;
                                                                  DIG 4 ;
                                                                  UPDATE 5 ;
                                                                  SOME ;
                                                                  DIG 4 ;
                                                                  CAR ;
                                                                  UPDATE ;
                                                                  UPDATE 5 ;
                                                                  SWAP ;
                                                                  PAIR } } } } } }
                                       { IF_LEFT
                                           { DIG 2 ;
                                             DIG 3 ;
                                             DROP 2 ;
                                             DUP 2 ;
                                             GET 11 ;
                                             IF { DROP 2 ; PUSH nat 220 ; FAILWITH }
                                                { DUP 2 ;
                                                  GET 5 ;
                                                  DUP 2 ;
                                                  CAR ;
                                                  GET ;
                                                  IF_NONE { PUSH nat 202 ; FAILWITH } {} ;
                                                  DUP ;
                                                  GET 5 ;
                                                  DUP ;
                                                  GET 17 ;
                                                  NOW ;
                                                  COMPARE ;
                                                  GT ;
                                                  DUP 2 ;
                                                  GET 9 ;
                                                  NOW ;
                                                  COMPARE ;
                                                  LT ;
                                                  OR ;
                                                  IF { DROP 4 ; PUSH nat 211 ; FAILWITH }
                                                     { DUP 2 ;
                                                       CAR ;
                                                       SENDER ;
                                                       COMPARE ;
                                                       NEQ ;
                                                       IF { DROP 4 ; PUSH nat 215 ; FAILWITH }
                                                          { PUSH nat 3 ;
                                                            DUP 2 ;
                                                            GET 22 ;
                                                            COMPARE ;
                                                            EQ ;
                                                            IF { DROP 4 ; PUSH nat 216 ; FAILWITH }
                                                               { PUSH nat 1 ;
                                                                 DUP 2 ;
                                                                 GET 22 ;
                                                                 ADD ;
                                                                 DUP 4 ;
                                                                 GET 3 ;
                                                                 GET 4 ;
                                                                 DUP 5 ;
                                                                 GET 3 ;
                                                                 CAR ;
                                                                 PAIR ;
                                                                 PACK ;
                                                                 SHA256 ;
                                                                 DUP 3 ;
                                                                 GET 11 ;
                                                                 SWAP ;
                                                                 COMPARE ;
                                                                 NEQ ;
                                                                 IF { DROP 5 ; PUSH nat 217 ; FAILWITH }
                                                                    { DUP 5 ;
                                                                      DIG 5 ;
                                                                      GET 5 ;
                                                                      DIG 4 ;
                                                                      DIG 4 ;
                                                                      DUP 6 ;
                                                                      GET 3 ;
                                                                      CAR ;
                                                                      UPDATE 13 ;
                                                                      DIG 4 ;
                                                                      UPDATE 22 ;
                                                                      DUP 5 ;
                                                                      GET 4 ;
                                                                      UPDATE 15 ;
                                                                      UPDATE 5 ;
                                                                      SOME ;
                                                                      DIG 3 ;
                                                                      CAR ;
                                                                      UPDATE ;
                                                                      UPDATE 5 ;
                                                                      NIL operation ;
                                                                      PAIR } } } } } }
                                           { IF_LEFT
                                               { DIG 2 ;
                                                 DIG 3 ;
                                                 DROP 2 ;
                                                 DUP 2 ;
                                                 GET 11 ;
                                                 IF { DROP 2 ; PUSH nat 220 ; FAILWITH }
                                                    { DUP 2 ;
                                                      GET 5 ;
                                                      DUP 2 ;
                                                      GET ;
                                                      IF_NONE { PUSH nat 202 ; FAILWITH } {} ;
                                                      DUP ;
                                                      CAR ;
                                                      SENDER ;
                                                      COMPARE ;
                                                      NEQ ;
                                                      IF { DROP 3 ; PUSH nat 221 ; FAILWITH }
                                                         { SELF_ADDRESS ;
                                                           DUP 2 ;
                                                           GET 5 ;
                                                           GET 3 ;
                                                           COMPARE ;
                                                           NEQ ;
                                                           IF { DROP 3 ; PUSH nat 218 ; FAILWITH }
                                                              { NIL (pair address (list (pair address nat nat))) ;
                                                                NIL (pair address nat nat) ;
                                                                DUP 3 ;
                                                                GET 7 ;
                                                                DUP 4 ;
                                                                GET 3 ;
                                                                SENDER ;
                                                                PAIR 3 ;
                                                                CONS ;
                                                                SELF_ADDRESS ;
                                                                PAIR ;
                                                                CONS ;
                                                                SWAP ;
                                                                GET 9 ;
                                                                CONTRACT %transfer (list (pair address (list (pair address nat nat)))) ;
                                                                IF_NONE { PUSH nat 201 ; FAILWITH } {} ;
                                                                SWAP ;
                                                                MAP { DUP ;
                                                                      CDR ;
                                                                      MAP { DUP ; GET 4 ; DUP 2 ; GET 3 ; PAIR ; SWAP ; CAR ; PAIR } ;
                                                                      SWAP ;
                                                                      CAR ;
                                                                      PAIR } ;
                                                                SWAP ;
                                                                PUSH mutez 0 ;
                                                                DIG 2 ;
                                                                TRANSFER_TOKENS ;
                                                                DUP 3 ;
                                                                DIG 3 ;
                                                                GET 5 ;
                                                                NONE (pair address
                                                                           nat
                                                                           (pair nat
                                                                                 address
                                                                                 string
                                                                                 timestamp
                                                                                 timestamp
                                                                                 bytes
                                                                                 nat
                                                                                 bool
                                                                                 timestamp
                                                                                 nat
                                                                                 nat
                                                                                 nat)
                                                                           nat
                                                                           address
                                                                           string
                                                                           (set string)) ;
                                                                DIG 4 ;
                                                                UPDATE ;
                                                                UPDATE 5 ;
                                                                NIL operation ;
                                                                DIG 2 ;
                                                                CONS ;
                                                                PAIR } } } }
                                               { DUP 2 ;
                                                 GET 11 ;
                                                 IF { DROP 4 ; PUSH nat 220 ; FAILWITH }
                                                    { DUP 2 ;
                                                      GET 5 ;
                                                      DUP 2 ;
                                                      GET ;
                                                      IF_NONE { PUSH nat 202 ; FAILWITH } {} ;
                                                      DUP 3 ;
                                                      CAR ;
                                                      DUP 2 ;
                                                      GET 9 ;
                                                      COMPARE ;
                                                      NEQ ;
                                                      IF { PUSH nat 0 ; SELF_ADDRESS ; PAIR }
                                                         { DUP 3 ;
                                                           GET 3 ;
                                                           DUP 2 ;
                                                           GET 3 ;
                                                           VIEW "get_royalties" (pair (address %issuer) (nat %royalties)) ;
                                                           IF_NONE { PUSH string "no royalties" ; FAILWITH } {} } ;
                                                      DUP 2 ;
                                                      GET 5 ;
                                                      GET 17 ;
                                                      NOW ;
                                                      COMPARE ;
                                                      LT ;
                                                      IF { DROP 6 ; PUSH nat 212 ; FAILWITH }
                                                         { PUSH mutez 0 ;
                                                           AMOUNT ;
                                                           COMPARE ;
                                                           NEQ ;
                                                           IF { DROP 6 ; PUSH nat 213 ; FAILWITH }
                                                              { DUP 2 ;
                                                                GET 5 ;
                                                                DUP 5 ;
                                                                DUP 2 ;
                                                                GET 5 ;
                                                                PAIR ;
                                                                DIG 6 ;
                                                                SWAP ;
                                                                EXEC ;
                                                                DUP 6 ;
                                                                DUP 3 ;
                                                                GET 5 ;
                                                                DUP 4 ;
                                                                GET 13 ;
                                                                DUP 7 ;
                                                                GET 11 ;
                                                                PAIR 4 ;
                                                                DIG 7 ;
                                                                SWAP ;
                                                                EXEC ;
                                                                PUSH bool False ;
                                                                DUP 4 ;
                                                                GET 15 ;
                                                                COMPARE ;
                                                                EQ ;
                                                                DUP 4 ;
                                                                CAR ;
                                                                DIG 2 ;
                                                                COMPARE ;
                                                                GT ;
                                                                AND ;
                                                                IF { DIG 2 ;
                                                                     DROP ;
                                                                     NIL (pair address (list (pair address nat nat))) ;
                                                                     NIL (pair address nat nat) ;
                                                                     DUP 5 ;
                                                                     GET 7 ;
                                                                     DUP 6 ;
                                                                     GET 3 ;
                                                                     DUP 7 ;
                                                                     CAR ;
                                                                     PAIR 3 ;
                                                                     CONS ;
                                                                     SELF_ADDRESS ;
                                                                     PAIR ;
                                                                     CONS ;
                                                                     DIG 3 ;
                                                                     GET 9 ;
                                                                     CONTRACT %transfer (list (pair address (list (pair address nat nat)))) ;
                                                                     IF_NONE { PUSH nat 201 ; FAILWITH } {} ;
                                                                     SWAP ;
                                                                     MAP { DUP ;
                                                                           CDR ;
                                                                           MAP { DUP ; GET 4 ; DUP 2 ; GET 3 ; PAIR ; SWAP ; CAR ; PAIR } ;
                                                                           SWAP ;
                                                                           CAR ;
                                                                           PAIR } ;
                                                                     SWAP ;
                                                                     PUSH mutez 0 ;
                                                                     DIG 2 ;
                                                                     TRANSFER_TOKENS ;
                                                                     SELF_ADDRESS ;
                                                                     DUP 4 ;
                                                                     GET 3 ;
                                                                     COMPARE ;
                                                                     EQ ;
                                                                     IF { SWAP ; DIG 2 ; DROP 2 ; NIL operation }
                                                                        { PUSH string "XTZ" ;
                                                                          DUP 4 ;
                                                                          GET 5 ;
                                                                          COMPARE ;
                                                                          EQ ;
                                                                          IF { SWAP ;
                                                                               DROP ;
                                                                               PUSH mutez 1 ;
                                                                               DUP 3 ;
                                                                               CAR ;
                                                                               MUL ;
                                                                               DIG 2 ;
                                                                               GET 3 ;
                                                                               CONTRACT unit ;
                                                                               IF_NONE { PUSH nat 205 ; FAILWITH } {} ;
                                                                               SWAP ;
                                                                               UNIT ;
                                                                               TRANSFER_TOKENS }
                                                                             { DUP 3 ;
                                                                               CAR ;
                                                                               DIG 3 ;
                                                                               GET 3 ;
                                                                               SELF_ADDRESS ;
                                                                               DIG 4 ;
                                                                               PAIR 4 ;
                                                                               UNPAIR 4 ;
                                                                               CONTRACT %transfer (pair (address %from) (address %to) (nat %value)) ;
                                                                               IF_NONE { PUSH nat 228 ; FAILWITH } {} ;
                                                                               PUSH mutez 0 ;
                                                                               DIG 4 ;
                                                                               DIG 4 ;
                                                                               DIG 4 ;
                                                                               PAIR 3 ;
                                                                               TRANSFER_TOKENS } ;
                                                                          NIL operation ;
                                                                          DIG 2 ;
                                                                          CONS } ;
                                                                     SWAP ;
                                                                     CONS ;
                                                                     DUP 3 ;
                                                                     DIG 3 ;
                                                                     GET 5 ;
                                                                     NONE (pair address
                                                                                nat
                                                                                (pair nat
                                                                                      address
                                                                                      string
                                                                                      timestamp
                                                                                      timestamp
                                                                                      bytes
                                                                                      nat
                                                                                      bool
                                                                                      timestamp
                                                                                      nat
                                                                                      nat
                                                                                      nat)
                                                                                nat
                                                                                address
                                                                                string
                                                                                (set string)) ;
                                                                     DIG 4 ;
                                                                     UPDATE ;
                                                                     UPDATE 5 ;
                                                                     SWAP ;
                                                                     PAIR }
                                                                   { SELF_ADDRESS ;
                                                                     DUP 3 ;
                                                                     GET 3 ;
                                                                     COMPARE ;
                                                                     NEQ ;
                                                                     IF { PUSH nat 10000 ;
                                                                          DUP 4 ;
                                                                          CDR ;
                                                                          DUP 4 ;
                                                                          CAR ;
                                                                          MUL ;
                                                                          EDIV ;
                                                                          IF_NONE { PUSH string "DIV by 0" ; FAILWITH } {} ;
                                                                          CAR ;
                                                                          PUSH nat 10000 ;
                                                                          DUP 8 ;
                                                                          GET 9 ;
                                                                          DUP 5 ;
                                                                          CAR ;
                                                                          MUL ;
                                                                          EDIV ;
                                                                          IF_NONE { PUSH string "DIV by 0" ; FAILWITH } {} ;
                                                                          CAR ;
                                                                          DUP ;
                                                                          DUP 3 ;
                                                                          DUP 6 ;
                                                                          CAR ;
                                                                          SUB ;
                                                                          SUB ;
                                                                          ISNAT ;
                                                                          IF_NONE { PUSH nat 204 ; FAILWITH } {} ;
                                                                          NIL (pair address (list (pair address nat nat))) ;
                                                                          NIL (pair address nat nat) ;
                                                                          DUP 9 ;
                                                                          GET 7 ;
                                                                          DUP 10 ;
                                                                          GET 3 ;
                                                                          DUP 9 ;
                                                                          GET 3 ;
                                                                          PAIR 3 ;
                                                                          CONS ;
                                                                          SELF_ADDRESS ;
                                                                          PAIR ;
                                                                          CONS ;
                                                                          DUP 8 ;
                                                                          GET 9 ;
                                                                          CONTRACT %transfer (list (pair address (list (pair address nat nat)))) ;
                                                                          IF_NONE { PUSH nat 201 ; FAILWITH } {} ;
                                                                          SWAP ;
                                                                          MAP { DUP ;
                                                                                CDR ;
                                                                                MAP { DUP ; GET 4 ; DUP 2 ; GET 3 ; PAIR ; SWAP ; CAR ; PAIR } ;
                                                                                SWAP ;
                                                                                CAR ;
                                                                                PAIR } ;
                                                                          SWAP ;
                                                                          PUSH mutez 0 ;
                                                                          DIG 2 ;
                                                                          TRANSFER_TOKENS ;
                                                                          DIG 7 ;
                                                                          CAR ;
                                                                          SELF_ADDRESS ;
                                                                          DUP 7 ;
                                                                          DUP 9 ;
                                                                          GET 5 ;
                                                                          DIG 5 ;
                                                                          NIL operation ;
                                                                          DIG 6 ;
                                                                          CONS ;
                                                                          PAIR 6 ;
                                                                          UNPAIR 6 ;
                                                                          PUSH nat 0 ;
                                                                          DUP 3 ;
                                                                          COMPARE ;
                                                                          GT ;
                                                                          IF { PUSH string "XTZ" ;
                                                                               DIG 3 ;
                                                                               COMPARE ;
                                                                               EQ ;
                                                                               IF { DIG 2 ;
                                                                                    DIG 3 ;
                                                                                    DROP 2 ;
                                                                                    PUSH mutez 1 ;
                                                                                    DIG 2 ;
                                                                                    MUL ;
                                                                                    DIG 2 ;
                                                                                    CONTRACT unit ;
                                                                                    IF_NONE { PUSH nat 205 ; FAILWITH } {} ;
                                                                                    SWAP ;
                                                                                    UNIT ;
                                                                                    TRANSFER_TOKENS }
                                                                                  { DIG 2 ;
                                                                                    CONTRACT %transfer (pair (address %from) (address %to) (nat %value)) ;
                                                                                    IF_NONE { PUSH nat 228 ; FAILWITH } {} ;
                                                                                    PUSH mutez 0 ;
                                                                                    DIG 3 ;
                                                                                    DIG 5 ;
                                                                                    DIG 5 ;
                                                                                    PAIR 3 ;
                                                                                    TRANSFER_TOKENS } ;
                                                                               CONS }
                                                                             { SWAP ; DIG 2 ; DIG 3 ; DIG 4 ; DIG 5 ; DROP 5 } ;
                                                                          DIG 5 ;
                                                                          CAR ;
                                                                          SELF_ADDRESS ;
                                                                          DUP 6 ;
                                                                          DUP 8 ;
                                                                          GET 5 ;
                                                                          DIG 6 ;
                                                                          DIG 5 ;
                                                                          PAIR 6 ;
                                                                          UNPAIR 6 ;
                                                                          PUSH nat 0 ;
                                                                          DUP 3 ;
                                                                          COMPARE ;
                                                                          GT ;
                                                                          IF { PUSH string "XTZ" ;
                                                                               DIG 3 ;
                                                                               COMPARE ;
                                                                               EQ ;
                                                                               IF { DIG 2 ;
                                                                                    DIG 3 ;
                                                                                    DROP 2 ;
                                                                                    PUSH mutez 1 ;
                                                                                    DIG 2 ;
                                                                                    MUL ;
                                                                                    DIG 2 ;
                                                                                    CONTRACT unit ;
                                                                                    IF_NONE { PUSH nat 205 ; FAILWITH } {} ;
                                                                                    SWAP ;
                                                                                    UNIT ;
                                                                                    TRANSFER_TOKENS }
                                                                                  { DIG 2 ;
                                                                                    CONTRACT %transfer (pair (address %from) (address %to) (nat %value)) ;
                                                                                    IF_NONE { PUSH nat 228 ; FAILWITH } {} ;
                                                                                    PUSH mutez 0 ;
                                                                                    DIG 3 ;
                                                                                    DIG 5 ;
                                                                                    DIG 5 ;
                                                                                    PAIR 3 ;
                                                                                    TRANSFER_TOKENS } ;
                                                                               CONS }
                                                                             { SWAP ; DIG 2 ; DIG 3 ; DIG 4 ; DIG 5 ; DROP 5 } ;
                                                                          DUP 6 ;
                                                                          GET 20 ;
                                                                          SELF_ADDRESS ;
                                                                          DIG 4 ;
                                                                          DIG 5 ;
                                                                          GET 5 ;
                                                                          DIG 5 ;
                                                                          DIG 5 ;
                                                                          PAIR 6 ;
                                                                          UNPAIR 6 ;
                                                                          PUSH nat 0 ;
                                                                          DUP 3 ;
                                                                          COMPARE ;
                                                                          GT ;
                                                                          IF { DUP 6 ;
                                                                               CONTRACT %deposit
                                                                                 (pair (string %token) (address %fa12_address) (nat %token_amount)) ;
                                                                               IF_NONE
                                                                                 { DROP 6 ; PUSH string "wrong treasury contract" ; FAILWITH }
                                                                                 { DUP 3 ;
                                                                                   DUP 6 ;
                                                                                   DUP 6 ;
                                                                                   PAIR 3 ;
                                                                                   PUSH string "XTZ" ;
                                                                                   DIG 5 ;
                                                                                   COMPARE ;
                                                                                   EQ ;
                                                                                   IF { DIG 4 ;
                                                                                        DIG 5 ;
                                                                                        DIG 6 ;
                                                                                        DROP 3 ;
                                                                                        DUG 2 ;
                                                                                        PUSH mutez 1 ;
                                                                                        DIG 4 ;
                                                                                        MUL ;
                                                                                        DIG 3 ;
                                                                                        PAIR 3 ;
                                                                                        UNPAIR 3 ;
                                                                                        TRANSFER_TOKENS }
                                                                                      { DIG 2 ;
                                                                                        DIG 4 ;
                                                                                        CONTRACT %transfer (pair (address %from) (address %to) (nat %value)) ;
                                                                                        IF_NONE { PUSH nat 228 ; FAILWITH } {} ;
                                                                                        PUSH mutez 0 ;
                                                                                        DIG 5 ;
                                                                                        DIG 7 ;
                                                                                        DIG 7 ;
                                                                                        PAIR 3 ;
                                                                                        TRANSFER_TOKENS ;
                                                                                        CONS ;
                                                                                        DIG 2 ;
                                                                                        PUSH mutez 0 ;
                                                                                        DIG 3 ;
                                                                                        TRANSFER_TOKENS } ;
                                                                                   CONS } }
                                                                             { SWAP ; DIG 2 ; DIG 3 ; DIG 4 ; DIG 5 ; DROP 5 } ;
                                                                          DUP 3 ;
                                                                          DIG 3 ;
                                                                          GET 5 ;
                                                                          NONE (pair address
                                                                                     nat
                                                                                     (pair nat
                                                                                           address
                                                                                           string
                                                                                           timestamp
                                                                                           timestamp
                                                                                           bytes
                                                                                           nat
                                                                                           bool
                                                                                           timestamp
                                                                                           nat
                                                                                           nat
                                                                                           nat)
                                                                                     nat
                                                                                     address
                                                                                     string
                                                                                     (set string)) ;
                                                                          DIG 4 ;
                                                                          UPDATE ;
                                                                          UPDATE 5 ;
                                                                          SWAP ;
                                                                          PAIR }
                                                                        { DROP 6 ; PUSH string "failed collect" ; FAILWITH } } } } } } } } } } } } } } } } }

